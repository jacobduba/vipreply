<%= turbo_frame_tag "template-selector" do %>
  <div id="template-selector-body" class="absolute top-11 right-0 w-full max-w-[36rem] border border-gray-200 bg-gray-50 rounded-lg shadow-sm animate-fade-in">
    <div class="px-3 border-b border-gray-200 flex justify-between items-center">
      <ul class="flex flex-wrap gap-3 pt-3 text-sm font-medium text-center text-slate-500">
        <li class="me-2">
          <div class="inline-flex items-center gap-2 pb-3 border-b-2 text-gray-800 border-gray-800 hover:cursor-default">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 0 1 6 3.75h2.25A2.25 2.25 0 0 1 10.5 6v2.25a2.25 2.25 0 0 1-2.25 2.25H6a2.25 2.25 0 0 1-2.25-2.25V6ZM3.75 15.75A2.25 2.25 0 0 1 6 13.5h2.25a2.25 2.25 0 0 1 2.25 2.25V18a2.25 2.25 0 0 1-2.25 2.25H6A2.25 2.25 0 0 1 3.75 18v-2.25ZM13.5 6a2.25 2.25 0 0 1 2.25-2.25H18A2.25 2.25 0 0 1 20.25 6v2.25A2.25 2.25 0 0 1 18 10.5h-2.25a2.25 2.25 0 0 1-2.25-2.25V6ZM13.5 15.75a2.25 2.25 0 0 1 2.25-2.25H18a2.25 2.25 0 0 1 2.25 2.25V18A2.25 2.25 0 0 1 18 20.25h-2.25A2.25 2.25 0 0 1 13.5 18v-2.25Z" />
            </svg>
            Select templates
          </div>
        </li>
        <li class="me-2">
          <%= link_to new_template_dropdown_topic_path, class: "inline-flex items-center gap-2 pb-3 border-b-2 border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-500" do %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
            Create new template
          <% end %>
        </li>
      </ul>
      <button type="button"
              data-action="click->template-selector-dropdown#toggle">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-gray-400 hover:text-gray-600">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="p-3 flex flex-col gap-3 overflow-y-auto max-h-[550px] relative"
         data-controller="template-selector-form">
      <% if @templates.present? %>
        <% @templates.each do |template| %>
          <div data-template-selector-form-target="templateRow"
             data-selected="<%= @topic.template_ids.include?(template.id) %>"
             data-is-checked="false"
             class="text-sm text-left rounded-lg w-full flex items-center border-gray-200 border text-gray-600
                    data-[selected=true]:[&:not([data-is-checked=true])]:bg-gray-100
                    data-[is-checked=true]:bg-blue-50
                    data-[is-checked=true]:text-blue-600
                    data-[is-checked=true]:border-blue-200">
            <div class="group grid size-4 grid-cols-1 mx-4 flex-none">
              <%= check_box_tag "template_ids[]",
                              template.id,
                              false,
                              data: {
                                template_selector_form_target: "templateCheckbox",
                                action: "template-selector-form#toggleCheck"
                              },
                              form: :multi_template_form,
                              class: "col-start-1 row-start-1 appearance-none rounded border border-gray-300 bg-white checked:border-blue-600 checked:bg-blue-600" %>
              <svg class="pointer-events-none col-start-1 row-start-1 size-3.5 self-center justify-self-center stroke-white group-has-[:disabled]:stroke-gray-950/25" viewBox="0 0 14 14" fill="none">
                <path class="opacity-0 group-has-[:checked]:opacity-100" d="M3 8L6 11L11 3.5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                <path class="opacity-0 group-has-[:indeterminate]:opacity-100" d="M3 7H11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </div>
            <%= form_with url: change_templates_regenerate_response_topic_path(@topic),
              method: :patch,
              class: "flex-1",
              data: {
                action: "turbo:submit-end->template-selector-dropdown#toggle
                        turbo:submit-start->template-selector-dropdown#showLoadingOverlay"
              } do |f| %>
              <%= f.hidden_field :template_ids, value: [template.id] %>
              <%= f.submit template.output,
              class: "text-left text-gray-700 py-3 pr-3 w-full whitespace-normal hover:cursor-pointer" %>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <div class="my-2">
          <div class="flex justify-center mb-2">
            <%= image_tag "no_templates.svg", class: "w-40", alt: "No templates available yet." %>
          </div>
          <p class="text-center text-gray-500 text-xl">No templates available yet.</p>
        </div>
      <% end %>
      <%= form_with model: @topic,
          url: change_templates_regenerate_response_topic_path(@topic),
          id: :multi_template_form,
          method: :patch,
          data: {
            action: "turbo:submit-end->template-selector-dropdown#toggle
                    turbo:submit-start->template-selector-dropdown#showLoadingOverlay",
            template_selector_form_target: "multiselect",
            total_checked: 0,
          },
          class: "data-[total-checked=0]:hidden flex justify-center sticky bottom-0 right-0 left-0" do |form| %>
        <button type="submit" class="text-white bg-blue-500 hover:bg-blue-600 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-full text-sm px-5 py-2.5 text-center inline-flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
          </svg>
          <span data-template-selector-form-target="buttonText"></span>
        </button>
      <% end %>
    </div>
    <!-- Loading Overlay -->
    <div class="hidden data-[loading]:flex absolute top-0 bottom-0 left-0 right-0 bg-white bg-opacity-75 rounded-lg items-center justify-center" data-template-selector-dropdown-target="loadingOverlay">
      <svg class="animate-spin h-8 w-8 text-blue-600 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>
  </div>
<% end %>
